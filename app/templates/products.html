{% extends "base.html" %}

{% block title %}{{ product.name }} - The Divine{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/products_page.css') }}">
{% endblock %}

{% block content %}
<div class="product-detail-container">
    <div class="product-image">
        <img src="{{ url_for('static', filename=product.image_url) }}" alt="{{ product.name }}">
    </div>
    <div class="product-info">
        <h1>{{ product.name }}</h1>
        <p class="price">Price: £{{ product.price }}</p>
        <p class="collection">Collection: {{ product.collection if product.collection else "None" }}</p>
        <p class="availability">
            {% if product.in_stock %}
                <span class="in-stock">In Stock</span>
            {% else %}
                <span class="out-of-stock">Out of Stock</span>
            {% endif %}
        </p>
        <p class="description">{{ product.description }}</p>
    </div>
</div>

<!-- Review Section -->
<div class="review-section">
    <h2>Customer Reviews</h2>

    <!-- If no reviews yet -->
    {% if not reviews %}
        <p>No reviews yet. Be the first to leave a review!</p>
        {% if not current_user.is_authenticated %}
            <p>
                <strong>
                    <a href="{{ url_for('routes.login', redirect='products', product_id=product.id) }}" 
                    style="text-decoration: underline; color: inherit;">
                        You have to log in to comment on this product.
                    </a>
                </strong>
            </p>
        {% endif %}
    {% else %}
        <div class="reviews">
            {% for review in reviews %}
                <div class="review">
                    <p><strong>Rating:</strong> ⭐ {{ review.rating }}</p>
                    <p>{{ review.review }}</p>

                    {% if current_user.is_authenticated and current_user.id == review.user_id %}
                        <!-- Show Delete button if the review belongs to the logged-in user -->
                        <form method="POST" action="{{ url_for('delete_review', product_id=product.id) }}">
                            <button type="submit" class="delete-review-btn">Delete</button>
                        </form>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Review Form (Only if user is logged in) -->
    {% if current_user.is_authenticated %}
        {% set user_review = reviews | selectattr("user_id", "equalto", current_user.id) | list %}

        {% if user_review %}
            <h3>Edit Your Review</h3>
        {% else %}
            <h3>Leave a Review</h3>
        {% endif %}

        <form method="POST" action="{{ url_for('routes.add_review', product_id=product.id) }}">
            <label for="review">Your Review:</label>
            <textarea name="review" id="review" rows="4" required>{{ user_review[0].review if user_review else "" }}</textarea>

            <label for="rating">Rating:</label>
            <select name="rating" id="rating" required>
                {% for i in range(5, 0, -1) %}
                    <option value="{{ i }}" {% if user_review and user_review[0].rating == i %}selected{% endif %}>⭐ {{ i }}</option>
                {% endfor %}
            </select>

            <button type="submit">{{ "Update Review" if user_review else "Submit Review" }}</button>
        </form>
    {% endif %}
</div>

{% endblock %}
